---
title: "Scatter Plot + Correlation Heatmap Matrix"
output: html_document
date: "2024-01-23"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Sourced cor_func from Stack Overflow: https://stackoverflow.com/questions/67835644/how-can-i-remove-the-corr-text-from-the-correlation-matrix-done-with-ggally
This code is to be inserted under print(pheatd) which is around line 500 in cluster_arm.Rmd
```{R}
library(GGally)   
library(mvtnorm)
library(ggplot2)
#order dataframe to match heatmap dendogram cluster ordering
ordered_df <- num_cdata_scaled[pheatd$tree_row$order]
ordered_df_arm <- cbind(ordered_df, tdata[,"arm_name"])
#count number of columns to use for coordinate system in corr_scatter_plot 
num_antibodies <- ncol(ordered_df)
#only show correlation between subsetted members, instead of all of them
cor_func <- function(data, mapping, ...){
  x <- eval_data_col(data, mapping$x)
  y <- eval_data_col(data, mapping$y)
  
  corr <- cor(x, y)
  
  ggally_text(
    label = as.character(round(corr, 2)), 
    mapping = aes(),
    xP = 0.5, yP = 0.5,
    color = 'black',
    size = 36/num_antibodies
  )
}
#create custom function to make density plots with empty fill
diag_plots <- function(data, mapping, ...) {
    ggplot(data = data, mapping = mapping) +
        geom_density(...)
} 
#initialize the scatterplot + heatmap combo
corr_scatter_plot <- ggpairs(ordered_df_arm, progress=F, columns=1:num_antibodies,
                             aes(color = factor(arm_name)), legend=1,
                             lower=list(continuous = wrap("points", size=1/600)),
                             upper=list(continuous = wrap(cor_func)),
                             diag = list(continuous = wrap(diag_plots))) +
                      scale_color_manual(values=arm.color) +
                      theme(legend.position = "bottom", axis.text=element_blank(), axis.ticks=element_blank()) + 
                      theme(strip.text.x = element_text(size = 60/num_antibodies), strip.text.y = element_text(size = 30/num_antibodies)) +
                      labs(color = 'Arm')
#perform color mapping done in pheatmap manually to match colors
color_mapping <- colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(100)
correlation_colors <- (cor(ordered_df)+1+2/99)*99/2 #maps values -1 to 1 on scale 1 to 100
selected_colors <- color_mapping[correlation_colors]
color_matrix <- matrix(selected_colors, ncol = num_antibodies)
#overwrite corr_scatter_plot cell by cell to add color in upper triangle
for (row in 1:(num_antibodies-1)){
  for (col in (row+1):num_antibodies){
    plt <- getPlot(corr_scatter_plot,row,col) +
           theme(panel.background = element_rect(fill = color_matrix[row,col], color="white"),
                 panel.grid.major = element_blank())
    corr_scatter_plot <- putPlot(corr_scatter_plot,plt,row,col)
  }
}
print(pheatd)
print(corr_scatter_plot)
```
